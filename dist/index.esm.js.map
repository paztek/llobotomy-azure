{"version":3,"file":"index.esm.js","sources":["../src/assistant/assistant.ts","../src/thread/tool.emulator.ts","../src/thread/message.converter.ts","../src/thread/thread.ts"],"sourcesContent":["import type {\n    ChatRequestMessage,\n    ChatRequestSystemMessage,\n    GetChatCompletionsOptions,\n    OpenAIClient,\n} from '@azure/openai';\nimport type { ChatCompletionsToolDefinition } from '@azure/openai/types/src/models/models';\nimport { Readable } from 'stream';\n\nexport interface AssistantCreateParams {\n    client: OpenAIClient;\n    instructions: string;\n    tools: ChatCompletionsToolDefinition[];\n    deployment: string;\n    useLegacyFunctions?: boolean;\n}\n\nexport class Assistant {\n    public readonly client: OpenAIClient;\n\n    private readonly instructions: string;\n    private readonly tools: ChatCompletionsToolDefinition[];\n    private readonly deployment: string;\n    private readonly useLegacyFunctions: boolean;\n\n    constructor(params: AssistantCreateParams) {\n        this.client = params.client;\n        this.instructions = params.instructions;\n        this.tools = params.tools;\n        this.deployment = params.deployment;\n        this.useLegacyFunctions = params.useLegacyFunctions ?? false;\n    }\n\n    async streamChatCompletions(\n        messages: ChatRequestMessage[],\n    ): Promise<Readable> {\n        // Prepend the messages with our instructions as a \"system\" message\n        const systemMessage: ChatRequestSystemMessage = {\n            role: 'system',\n            content: this.instructions,\n        };\n        messages = [systemMessage, ...messages];\n\n        const options: GetChatCompletionsOptions = {};\n\n        if (this.tools.length > 0) {\n            if (this.useLegacyFunctions) {\n                // Convert tools to functions\n                options.functions = this.tools.map((tool) => {\n                    return tool.function;\n                });\n            } else {\n                options.tools = this.tools;\n            }\n        }\n        const events = await this.client.streamChatCompletions(\n            this.deployment,\n            messages,\n            options,\n        );\n\n        return Readable.from(events);\n    }\n}\n","import type { FunctionCall } from '@azure/openai';\n\nconst EMULATED_CALL_PREFIX = 'emulated_call_';\n\n/**\n * Helps with the conversion of tool calls to function calls and vice versa.\n */\nexport class ToolEmulator {\n    generateEmulatedToolCallId(functionCall: FunctionCall): string {\n        return `${EMULATED_CALL_PREFIX}${functionCall.name}`;\n    }\n\n    isEmulatedToolCallId(toolCallId: string): boolean {\n        return toolCallId.startsWith(EMULATED_CALL_PREFIX);\n    }\n\n    extractFunctionNameFromEmulatedToolCallId(toolCallId: string): string {\n        return toolCallId.replace(EMULATED_CALL_PREFIX, '');\n    }\n}\n","import type {\n    ChatRequestAssistantMessage,\n    ChatRequestFunctionMessage,\n    ChatRequestMessage,\n    ChatRequestSystemMessage,\n    ChatRequestToolMessage,\n    ChatRequestUserMessage,\n} from '@azure/openai';\nimport type {\n    ChatMessage,\n    ChatRequestSystemMessageWithMetadata,\n    ChatRequestToolMessageWithMetadata,\n    ChatRequestUserMessageWithMetadata,\n    ChatResponseMessageWithMetadata,\n} from '../message';\nimport { ToolEmulator } from './tool.emulator';\n\nexport class ThreadMessageConverter {\n    private readonly toolEmulator = new ToolEmulator();\n\n    /**\n     * Convert the mix of ChatRequestMessages and ChatResponseMessages to ChatRequestMessages only\n     * so they can be sent again to the LLM.\n     */\n    convert(messages: ChatMessage[]): ChatRequestMessage[] {\n        return messages.map((m) => {\n            switch (m.role) {\n                case 'system': {\n                    const systemMessage =\n                        m as ChatRequestSystemMessageWithMetadata;\n                    return {\n                        role: 'system',\n                        content: systemMessage.content,\n                    } as ChatRequestSystemMessage;\n                }\n                case 'user': {\n                    const userMessage = m as ChatRequestUserMessageWithMetadata;\n                    return {\n                        role: 'user',\n                        content: userMessage.content,\n                        name: userMessage.name,\n                    } as ChatRequestUserMessage;\n                }\n                case 'tool': {\n                    const toolMessage = m as ChatRequestToolMessageWithMetadata;\n                    if (\n                        this.toolEmulator.isEmulatedToolCallId(\n                            toolMessage.toolCallId,\n                        )\n                    ) {\n                        return {\n                            role: 'function',\n                            content: toolMessage.content,\n                            name: this.toolEmulator.extractFunctionNameFromEmulatedToolCallId(\n                                toolMessage.toolCallId,\n                            ),\n                        } as ChatRequestFunctionMessage;\n                    }\n                    return {\n                        role: 'tool',\n                        content: toolMessage.content,\n                        toolCallId: toolMessage.toolCallId,\n                    } as ChatRequestToolMessage;\n                }\n                case 'assistant': {\n                    const assistantMessage =\n                        m as ChatResponseMessageWithMetadata;\n\n                    if (\n                        assistantMessage.toolCalls[0] &&\n                        this.toolEmulator.isEmulatedToolCallId(\n                            assistantMessage.toolCalls[0].id,\n                        )\n                    ) {\n                        // This is a function call\n                        return {\n                            role: 'assistant',\n                            content: assistantMessage.content,\n                            functionCall: {\n                                name: this.toolEmulator.extractFunctionNameFromEmulatedToolCallId(\n                                    assistantMessage.toolCalls[0].id,\n                                ),\n                                arguments:\n                                    assistantMessage.toolCalls[0].function\n                                        .arguments,\n                            },\n                        } as ChatRequestAssistantMessage;\n                    }\n\n                    return {\n                        role: 'assistant',\n                        content: assistantMessage.content,\n                        toolCalls: assistantMessage.toolCalls,\n                    } as ChatRequestAssistantMessage;\n                }\n                default:\n                    throw new Error(`Unknown message role ${m.role}`);\n            }\n        });\n    }\n}\n","import type {\n    ChatCompletions,\n    ChatCompletionsToolCall,\n    ChatRequestMessage,\n    ChatResponseMessage,\n    FunctionCall,\n} from '@azure/openai';\nimport EventEmitter from 'events';\nimport { Readable } from 'stream';\nimport { Assistant } from '../assistant';\nimport type {\n    ChatMessage,\n    ChatRequestMessageWithMetadata,\n    ChatRequestToolMessageWithMetadata,\n} from '../message';\nimport { ThreadMessageConverter } from './message.converter';\nimport { ToolEmulator } from './tool.emulator';\n\ninterface MultiToolUseParallelArguments {\n    tool_uses: {\n        recipient_name: string;\n        parameters: string;\n    }[];\n}\n\nexport class Thread extends EventEmitter {\n    private _stream: Readable | null = null;\n    private readonly _messages: ChatMessage[] = [];\n    private readonly converter = new ThreadMessageConverter();\n    private readonly toolEmulator = new ToolEmulator();\n\n    constructor(\n        public readonly id: string,\n        messages: ChatMessage[] = [],\n    ) {\n        super();\n        this._messages = messages;\n    }\n\n    get stream(): Readable | null {\n        return this._stream;\n    }\n\n    get messages(): ChatMessage[] {\n        // TODO Return a deep copy\n        return this._messages;\n    }\n\n    addMessage(message: ChatRequestMessageWithMetadata): void {\n        this.doAddMessage(message);\n    }\n\n    async run(assistant: Assistant): Promise<void> {\n        try {\n            return await this.doRun(assistant);\n        } catch (e) {\n            this.emitImmediate('error', e);\n        }\n    }\n\n    private async doRun(assistant: Assistant): Promise<void> {\n        if (this._stream) {\n            this._stream.push(null);\n        }\n\n        this._stream = new Readable({\n            read: () => {},\n        });\n\n        this.emitImmediate('in_progress');\n\n        const messages = this.converter.convert(this._messages);\n\n        const stream = await assistant.streamChatCompletions(messages);\n\n        let content: string | null = null;\n        const toolCalls: ChatCompletionsToolCall[] = [];\n        let functionCall: FunctionCall | undefined = undefined;\n\n        stream.on('data', (completion: ChatCompletions) => {\n            if (!completion.id || completion.id === '') {\n                // First completion is empty when using old models like gpt-35-turbo\n                return;\n            }\n            const choice = completion.choices[0];\n            if (!choice) {\n                const err = new Error('No completions returned');\n                return this.emitImmediate('error', err);\n            }\n\n            const delta = choice.delta;\n            if (!delta) {\n                const err = new Error('No delta returned');\n                return this.emitImmediate('error', err);\n            }\n\n            if (delta.content) {\n                content = content ? content + delta.content : delta.content;\n\n                // Write also to the stream of the thread\n                if (!this._stream) {\n                    const err = new Error('No stream available');\n                    return this.emitImmediate('error', err);\n                }\n                this._stream?.push(delta.content);\n            }\n\n            // Merge toolCalls\n            if (delta.toolCalls) {\n                for (const toolCall of delta.toolCalls) {\n                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment\n                    // @ts-ignore\n                    const index = toolCall['index']; // Not typed yet by the @azure/openai package\n                    const existingToolCall = toolCalls[index];\n\n                    if (existingToolCall) {\n                        existingToolCall.function.arguments +=\n                            toolCall.function.arguments;\n                    } else {\n                        toolCalls.push({\n                            type: toolCall.type,\n                            function: toolCall.function,\n                            id: toolCall.id,\n                        });\n                    }\n                }\n            }\n\n            // Merge functionCalls\n            if (delta.functionCall) {\n                if (functionCall) {\n                    functionCall.arguments += delta.functionCall.arguments;\n                } else {\n                    functionCall = {\n                        ...delta.functionCall,\n                        arguments: '',\n                    };\n                }\n            }\n\n            if (choice.finishReason === null) {\n                return;\n            }\n\n            let finalToolCalls: ChatCompletionsToolCall[];\n\n            if (toolCalls.length > 0) {\n                if (\n                    toolCalls.length === 1 &&\n                    toolCalls[0] &&\n                    toolCalls[0].type === 'function' &&\n                    toolCalls[0].function.name === 'multi_tool_use.parallel'\n                ) {\n                    /**\n                     * That seems to be an hallucination from the model,\n                     * we convert the payload into regular tool calls\n                     * See https://community.openai.com/t/model-tries-to-call-unknown-function-multi-tool-use-parallel/490653/8\n                     */\n                    const toolCall = toolCalls[0];\n                    const args = JSON.parse(\n                        toolCall.function.arguments,\n                    ) as MultiToolUseParallelArguments;\n                    /**\n                     * the arguments follow the structure:\n                     * {\n                     *     tool_uses: [\n                     *          {\n                     *              recipient_name: \"functions.actual_tool_name\",\n                     *              parameters: {\n                     *                  foo: \"bar\",\n                     *                  baz: true,\n                     *              }\n                     *          },\n                     *          ...\n                     *     ]\n                     * }\n                     */\n                    finalToolCalls = args.tool_uses.map(\n                        (\n                            toolUse: {\n                                recipient_name: string;\n                                parameters: unknown;\n                            },\n                            index,\n                        ) => {\n                            return {\n                                type: 'function',\n                                function: {\n                                    name: toolUse.recipient_name.replace(\n                                        'functions.',\n                                        '',\n                                    ),\n                                    arguments: JSON.stringify(\n                                        toolUse.parameters,\n                                    ),\n                                },\n                                id: `${toolCall.id}_${index}`,\n                            };\n                        },\n                    );\n                } else {\n                    finalToolCalls = [...toolCalls];\n                }\n            } else if (functionCall) {\n                /**\n                 * We received a legacy function call, we convert it to a tool call with an emulated ID\n                 */\n                const toolCall: ChatCompletionsToolCall = {\n                    type: 'function',\n                    function: functionCall,\n                    id: this.toolEmulator.generateEmulatedToolCallId(\n                        functionCall,\n                    ),\n                };\n                finalToolCalls = [toolCall];\n            } else {\n                finalToolCalls = [];\n            }\n\n            const message: ChatResponseMessage = {\n                role: 'assistant',\n                content,\n                toolCalls: finalToolCalls,\n            };\n\n            content = null;\n            toolCalls.splice(0, toolCalls.length);\n            functionCall = undefined;\n\n            this.doAddMessage(message);\n\n            switch (choice.finishReason) {\n                case 'stop':\n                    this._stream?.push(null);\n                    this.emitImmediate('completed');\n                    break;\n                case 'tool_calls':\n                case 'function_call': {\n                    if (message.toolCalls.length === 0) {\n                        const err = new Error('No tool calls returned');\n                        return this.emitImmediate('error', err);\n                    }\n                    this.dispatchRequiredAction(message.toolCalls, assistant);\n                    break;\n                }\n                default: {\n                    const err = new Error(\n                        `Unknown finish reason ${choice.finishReason}`,\n                    );\n                    return this.emitImmediate('error', err);\n                }\n            }\n        });\n    }\n\n    private dispatchRequiredAction(\n        toolCalls: ChatCompletionsToolCall[],\n        assistant: Assistant,\n    ): void {\n        const requiredAction = new RequiredAction(toolCalls);\n        requiredAction.on('submitting', async (toolOutputs: ToolOutput[]) =>\n            this.handleSubmittedToolOutputs(toolOutputs, assistant),\n        );\n        this.emitImmediate('requires_action', requiredAction);\n    }\n\n    private async handleSubmittedToolOutputs(\n        toolOutputs: ToolOutput[],\n        assistant: Assistant,\n    ): Promise<void> {\n        // Adds the tool outputs to the messages\n        for (const toolOutput of toolOutputs) {\n            const message: ChatRequestToolMessageWithMetadata = {\n                role: 'tool',\n                content: JSON.stringify(toolOutput.value),\n                toolCallId: toolOutput.callId,\n            };\n            if (toolOutput.metadata !== void 0) {\n                message.metadata = toolOutput.metadata;\n            }\n            this.doAddMessage(message);\n        }\n\n        return this.doRun(assistant);\n    }\n\n    private doAddMessage(\n        message: ChatRequestMessage | ChatResponseMessage,\n    ): void {\n        this._messages.push(message);\n\n        this.emitImmediate('message', message);\n\n        if (isChatRequestMessage(message)) {\n            this.emitImmediate('message:request', message);\n        } else {\n            this.emitImmediate('message:response', message);\n        }\n    }\n\n    private emitImmediate(event: string, ...args: unknown[]): void {\n        if (event === 'error') {\n            this.emit(event, ...args);\n        } else {\n            setImmediate(() => {\n                this.emit(event, ...args);\n            });\n        }\n    }\n}\n\nexport class RequiredAction extends EventEmitter {\n    constructor(public readonly toolCalls: ChatCompletionsToolCall[]) {\n        super();\n    }\n\n    submitToolOutputs(toolOutputs: ToolOutput[]): void {\n        this.emit('submitting', toolOutputs);\n    }\n}\n\nexport interface ToolOutput {\n    callId: string;\n    value: unknown;\n    metadata?: unknown;\n}\n\nexport function isChatResponseMessage(\n    m: ChatRequestMessage | ChatResponseMessage,\n): m is ChatResponseMessage {\n    return 'toolCalls' in m;\n}\n\nexport function isChatRequestMessage(\n    m: ChatRequestMessage | ChatResponseMessage,\n): m is ChatRequestMessage {\n    return !isChatResponseMessage(m);\n}\n"],"names":[],"mappings":"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"}